<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4f46e5">
  <title>SUDOKU</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-user-select: none;
      user-select: none;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    body {
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: max(1rem, env(safe-area-inset-top)) 1rem max(1rem, env(safe-area-inset-bottom)) 1rem;
      overflow: hidden;
    }

    .menu-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .title {
      text-align: center;
      margin-bottom: 1rem;
    }

    .title h1 {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .tab {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      background: #e5e7eb;
      color: #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .tab.active {
      background: #4f46e5;
      color: white;
    }

    .section {
      display: none;
      flex: 1;
      overflow-y: auto;
    }

    .section.active {
      display: flex;
      flex-direction: column;
    }

    .level-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .level-list h2 {
      font-size: 1.25rem;
      color: #374151;
      text-align: center;
      margin-bottom: 0.5rem;
      flex-shrink: 0;
    }

    .level-btn {
      width: 100%;
      padding: 1.5rem 1.25rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      flex: 1;
      min-height: 70px;
    }

    .level-name {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .level-desc {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .history-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .history-header h2 {
      font-size: 1.25rem;
      color: #374151;
    }

    .clear-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.75rem;
      background: #fef2f2;
      color: #ef4444;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid #fecaca;
    }

    .empty-history {
      text-align: center;
      padding: 3rem 2rem;
      color: #6b7280;
      background: #f9fafb;
      border-radius: 0.75rem;
      border: 1px dashed #e5e7eb;
    }

    .history-item {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }

    .history-level {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    .history-date {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .history-time {
      font-size: 1.25rem;
      font-weight: 700;
      color: #4f46e5;
      font-family: 'Roboto Mono', monospace;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .delete-history-btn {
      padding: 0.5rem;
      border: none;
      border-radius: 0.5rem;
      background: #fef2f2;
      color: #ef4444;
      cursor: pointer;
      display: flex;
      align-items: center;
      border: 1px solid #fecaca;
    }

    .game-screen {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .game-screen.active {
      display: flex;
    }

    #play-screen {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    #play-screen[style*="display: flex"],
    #play-screen[style*="display:flex"] {
      display: flex !important;
    }

    .countdown-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
    }

    .countdown-number {
      font-size: 8rem;
      font-weight: 700;
      color: white;
    }

    .countdown-level {
      font-size: 1.5rem;
      color: white;
      margin-top: 1rem;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      flex-shrink: 0;
      position: relative;
      min-height: 2.5rem;
    }

    .back-btn {
      background: none;
      border: none;
      color: #4f46e5;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      position: absolute;
      left: 0;
    }

    .timer {
      color: #667eea;
      font-size: 1.25rem;
      font-weight: 600;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .game-level-name {
      color: #4b5563;
      font-size: 0.875rem;
      font-weight: 600;
      position: absolute;
      right: 0;
    }

    .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      overflow-y: auto;
      gap: 0.75rem;
      padding: 0.5rem 0;
      min-height: 0;
    }

    .top-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
      flex-shrink: 0;
      padding: 0.5rem 0.25rem 0.25rem 0.25rem;
    }

    .control-btn {
      padding: 0.75rem;
      border: none;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      color: white;
      white-space: nowrap;
      min-height: 2.75rem;
    }

    .control-btn i {
      font-size: 1.1rem;
    }

    .error-btn { background: #fca5a5; }
    .error-btn.active { 
      background: #ef4444;
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.7), 0 0 24px rgba(239, 68, 68, 0.3);
    }
    .hint-btn { background: #f59e0b; }
    .reset-btn { background: #6b7280; }
    .pause-btn { background: #cbd5e1; }
    .pause-btn.active { 
      background: #f97316 !important;
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.8), 0 0 30px rgba(249, 115, 22, 0.4) !important;
      opacity: 1 !important;
    }
    .memo-btn { background: #cffafe; color: #0e7490; }
    .memo-btn.active { 
      background: #06b6d4;
      color: white;
      box-shadow: 0 0 12px rgba(6, 182, 212, 0.7), 0 0 24px rgba(6, 182, 212, 0.3);
    }

    .sudoku-board {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(9, 1fr);
      background: white;
      border: 3px solid #1f2937;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      overflow: hidden;
      flex-shrink: 0;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      background: white;
      border-right: 1px solid #d1d5db;
      border-bottom: 1px solid #d1d5db;
    }

    .cell:nth-child(9n) { border-right: none; }
    .cell:nth-child(n+73) { border-bottom: none; }
    .cell:nth-child(3n):not(:nth-child(9n)) { border-right: 2px solid #1f2937; }
    .cell:nth-child(n+19):nth-child(-n+27),
    .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #1f2937; }

    .cell.initial {
      background: #f3f4f6;
      color: #1f2937;
      cursor: default;
    }

    .cell.editable {
      color: #667eea;
    }

    .cell.editable:active {
      background: #eef2ff;
    }

    .cell.selected {
      background: #eef2ff;
      box-shadow: inset 0 0 0 3px #667eea;
    }

    .cell.selected.memo-active {
      box-shadow: inset 0 0 0 3px #06b6d4;
      background: #ecfeff;
    }

    .cell.wrong {
      background: #fee2e2;
      color: #ef4444;
    }

    .memo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      width: 100%;
      height: 100%;
      padding: 1px;
      font-size: 0.6rem;
      color: #9ca3af;
      position: absolute;
    }

    .memo-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .number-pad {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
      flex-shrink: 0;
    }

    .number-btn {
      aspect-ratio: 1.5 / 1;
      border: none;
      border-radius: 0.75rem;
      background: #4f46e5;
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 3rem;
    }

    .number-pad.memo-mode .number-btn:not(.delete-btn) {
      background: #06b6d4;
    }

    .delete-btn {
      background: #6b7280;
    }

    .bottom-controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
      flex-shrink: 0;
      padding: 0.25rem;
    }

    #board.paused {
      opacity: 0.5;
      pointer-events: none;
    }

    .control-btn.paused-disabled,
    .number-btn.paused-disabled,
    .landscape-btn.paused-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .control-btn.pause-btn.active,
    .bottom-controls .control-btn.pause-btn.active,
    .paused-overlay .control-btn.pause-btn.active {
      opacity: 1 !important;
      pointer-events: auto !important;
      background: #f97316 !important;
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.8), 0 0 30px rgba(249, 115, 22, 0.4) !important;
      position: relative !important;
      z-index: 10 !important;
    }

    .clear-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      z-index: 1000;
      padding: 2rem;
    }

    .clear-screen.active {
      display: flex;
    }

    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
    }

    .confirm-dialog.active {
      display: flex;
    }

    .confirm-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      min-width: 280px;
      max-width: 90vw;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .confirm-message {
      font-size: 1.1rem;
      color: #1f2937;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .confirm-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .confirm-btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .confirm-btn.cancel {
      background: #f3f4f6;
      color: #4b5563;
    }

    .confirm-btn.ok {
      background: #4f46e5;
      color: white;
    }

    .trophy-icon {
      width: 120px;
      height: 120px;
      margin-bottom: 1.5rem;
    }

    .clear-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .clear-message {
      font-size: 1.25rem;
      color: #4b5563;
      margin-bottom: 1.5rem;
    }

    .clear-stats {
      background: #f3f4f6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .clear-time-label {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .clear-time {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .clear-level {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
    }

    .clear-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      width: 100%;
      max-width: 300px;
    }

    .action-btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .primary-btn {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
    }

    .secondary-btn {
      background: #f3f4f6;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }

    /* 小さな画面の縦向き */
    @media (max-width: 640px) and (orientation: portrait) {
      .container { 
        padding: 0.5rem;
        padding-top: max(0.5rem, env(safe-area-inset-top));
        padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
      }
      .title h1 { font-size: 2rem; }
      
      .game-content { 
        padding: 0; 
        gap: 0.75rem;
        justify-content: flex-start;
        overflow-y: auto;
      }
      
      .sudoku-board {
        width: min(calc(100vw - 1rem), 450px);
        height: min(calc(100vw - 1rem), 450px);
        max-width: min(calc(100vw - 1rem), 450px);
        max-height: min(calc(100vw - 1rem), 450px);
        border: 2px solid #1f2937;
      }
      
      .top-controls,
      .number-pad,
      .bottom-controls { 
        width: min(calc(100vw - 1rem), 450px);
        max-width: min(calc(100vw - 1rem), 450px);
        gap: 0.4rem;
      }
      
      .cell { 
        font-size: clamp(1.15rem, 3.5vw, 1.5rem);
      }
      
      .control-btn { 
        font-size: 0.75rem;
        padding: 0.65rem 0.35rem;
        min-height: 2.7rem;
      }
      
      .control-btn i { 
        font-size: 1.05rem;
      }
      
      .number-btn { 
        font-size: clamp(1.25rem, 4vw, 1.5rem);
        min-height: 3.2rem;
      }
      
      .memo-grid { 
        font-size: clamp(0.45rem, 1.3vw, 0.6rem);
      }
    }

    /* 横向きレイアウト: 横向き画面で適用 */
    @media (orientation: landscape) and (max-height: 700px) {
      .container { 
        padding: 0.5rem;
        padding-top: max(0.5rem, env(safe-area-inset-top));
      }
      .title h1 { font-size: 1.5rem; }
      .game-header { margin-bottom: 0.5rem; }
      
      .game-content { 
        display: flex !important; 
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
        gap: 1.5rem !important;
        overflow: hidden !important;
      }
      
      .sudoku-board { 
        width: min(calc(100vh - 6rem), 60vw, 500px) !important; 
        height: min(calc(100vh - 6rem), 60vw, 500px) !important;
        max-width: min(calc(100vh - 6rem), 60vw, 500px) !important;
        max-height: min(calc(100vh - 6rem), 60vw, 500px) !important;
        min-width: min(calc(100vh - 6rem), 60vw, 500px) !important;
        min-height: min(calc(100vh - 6rem), 60vw, 500px) !important;
        border: 2px solid #1f2937 !important;
        border-radius: 6px !important;
        margin: 0 !important;
        flex-shrink: 0 !important;
      }
      
      .top-controls { display: none !important; }
      .bottom-controls { display: none !important; }
      
      .number-pad { 
        display: grid !important; 
        grid-template-columns: repeat(3, 1fr) !important; 
        grid-template-rows: repeat(5, 1fr) !important;
        width: auto !important;
        height: min(calc(100vh - 6rem), 60vw, 500px) !important;
        gap: 0.4rem !important;
        flex-shrink: 0 !important;
      }
      
      .number-pad .landscape-btn {
        width: 100% !important;
        height: 100% !important;
        min-width: 0 !important;
        min-height: 0 !important;
        aspect-ratio: 1 / 1 !important;
        padding: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 0.5rem !important;
      }
      
      .number-pad .landscape-btn i {
        font-size: clamp(1.1rem, 3vh, 1.5rem) !important;
        margin: 0 !important;
      }
      
      .number-pad .landscape-btn.number-btn {
        font-size: clamp(1.4rem, 4vh, 1.8rem) !important;
        font-weight: 700 !important;
      }
      
      .cell { 
        font-size: clamp(1.1rem, 2.8vh, 1.6rem) !important; 
      }
      
      .memo-grid {
        font-size: clamp(0.42rem, 0.9vh, 0.6rem) !important;
      }
    }

    /* 大きめの画面の縦向き */
    @media (min-width: 641px) and (orientation: portrait) {
      .sudoku-board {
        max-width: min(85vw, 550px);
      }

      .top-controls,
      .number-pad,
      .bottom-controls {
        max-width: min(85vw, 550px);
      }

      .cell {
        font-size: 1.6rem;
      }

      .control-btn {
        font-size: 0.8rem;
        padding: 0.8rem 0.4rem;
        min-height: 3rem;
      }

      .control-btn i {
        font-size: 1.15rem;
      }

      .number-btn {
        font-size: 1.6rem;
        min-height: 3.5rem;
      }

      .memo-grid {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="menu-screen" id="menu-screen">
      <div class="title">
        <h1>SUDOKU</h1>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('game', event)">
          <i class="material-icons-round">add</i>
          <span>新しいゲーム</span>
        </button>
        <button class="tab" onclick="showTab('history', event)">
          <i class="material-icons-round">history</i>
          <span>履歴</span>
        </button>
      </div>
  
      <div id="game-tab" class="section active">
        <div class="level-list">
          <h2>難易度を選択</h2>
          <button class="level-btn" onclick="startGame(0)">
            <div class="level-name">入門</div>
            <div class="level-desc">基本スキャンのみ</div>
          </button>
          <button class="level-btn" onclick="startGame(1)">
            <div class="level-name">簡単</div>
            <div class="level-desc">唯一候補法</div>
          </button>
          <button class="level-btn" onclick="startGame(2)">
            <div class="level-name">普通</div>
            <div class="level-desc">ペア削除が必要</div>
          </button>
          <button class="level-btn" onclick="startGame(3)">
            <div class="level-name">難しい</div>
            <div class="level-desc">複数技法の組み合わせ</div>
          </button>
          <button class="level-btn" onclick="startGame(4)">
            <div class="level-name">超難しい</div>
            <div class="level-desc">高度な論理推論</div>
          </button>
          <button class="level-btn" onclick="startGame(5)">
            <div class="level-name">激ムズ</div>
            <div class="level-desc">最高難易度の挑戦</div>
          </button>
        </div>
      </div>
  
      <div id="history-tab" class="section">
        <div class="history-header">
          <h2>クリア履歴</h2>
          <button class="clear-btn" onclick="clearHistory()" id="clear-history-btn" style="display:none">
            <i class="material-icons-round">delete</i>
            全て削除
          </button>
        </div>
        <div id="history-content"></div>
      </div>
    </div>

    <div id="game-screen" class="game-screen">
      <div id="countdown-screen" class="countdown-screen" style="display:none"></div>
  
      <div id="play-screen" style="display:none;">
        <div class="game-header">
          <button class="back-btn" onclick="backToMenu()">
            <i class="material-icons-round">arrow_back</i>
            <span>戻る</span>
          </button>
          <div class="timer" id="timer">0:00</div>
          <div class="game-level-name" id="level-name"></div>
        </div>
    
        <div class="game-content">
          <div class="top-controls">
            <button class="control-btn error-btn" id="error-btn" onclick="toggleErrors()">
              <i class="material-icons-round">error_outline</i>
              <span>間違い表示</span>
            </button>
            <button class="control-btn hint-btn" onclick="getHint()">
              <i class="material-icons-round">lightbulb</i>
              <span>ヒント</span>
            </button>
            <button class="control-btn reset-btn" onclick="resetGame()">
              <i class="material-icons-round">refresh</i>
              <span>リセット</span>
            </button>
          </div>

          <div class="sudoku-board" id="board"></div>
      
          <div class="number-pad" id="number-pad"></div>

          <div class="bottom-controls">
            <button class="control-btn pause-btn" id="pause-btn" onclick="togglePause()">
              <i class="material-icons-round">pause</i>
              <span>一時停止</span>
            </button>
            <button class="control-btn memo-btn" id="memo-btn" onclick="toggleMemo()">
              <i class="material-icons-round">edit_note</i>
              <span>メモ</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="clear-screen" class="clear-screen">
      <svg class="trophy-icon" viewBox="0 0 200 200">
        <defs>
          <linearGradient id="trophyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#fbbf24" />
            <stop offset="100%" style="stop-color:#f59e0b" />
          </linearGradient>
        </defs>
        <rect x="70" y="160" width="60" height="15" rx="3" fill="url(#trophyGradient)"/>
        <rect x="90" y="140" width="20" height="25" fill="url(#trophyGradient)"/>
        <path d="M 60 60 L 60 100 Q 60 130 100 130 Q 140 130 140 100 L 140 60 Z" fill="url(#trophyGradient)"/>
        <path d="M 60 70 Q 40 70 40 90 Q 40 100 50 100 L 60 100" fill="none" stroke="url(#trophyGradient)" stroke-width="8"/>
        <path d="M 140 70 Q 160 70 160 90 Q 160 100 150 100 L 140 100" fill="none" stroke="url(#trophyGradient)" stroke-width="8"/>
        <rect x="55" y="55" width="90" height="10" rx="3" fill="url(#trophyGradient)"/>
        <path d="M 100 25 L 105 40 L 120 40 L 108 50 L 113 65 L 100 55 L 87 65 L 92 50 L 80 40 L 95 40 Z" fill="#fbbf24" opacity="0.8"/>
      </svg>
      <h1 class="clear-title">おめでとう!</h1>
      <p class="clear-message">数独をクリアしました!</p>
  
      <div class="clear-stats">
        <div class="clear-time-label">クリアタイム</div>
        <div class="clear-time" id="clear-time">0:00</div>
        <div class="clear-level" id="clear-level"></div>
      </div>
  
      <div class="clear-actions">
        <button class="action-btn primary-btn" onclick="replayLevel()">
          <i class="material-icons-round">replay</i>
          <span>もう一度</span>
        </button>
        <button class="action-btn secondary-btn" onclick="backToMenu()">
          <i class="material-icons-round">home</i>
          <span>メニューに戻る</span>
        </button>
      </div>
    </div>

    <div id="confirm-dialog" class="confirm-dialog">
      <div class="confirm-content">
        <div class="confirm-message" id="confirm-message"></div>
        <div class="confirm-buttons">
          <button class="confirm-btn cancel" onclick="hideConfirm()">キャンセル</button>
          <button class="confirm-btn ok" id="confirm-ok-btn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // PWA Service Worker登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {
          // Service Workerが利用できない場合は無視
        });
      });
    }

    const LEVEL_NAMES = ['入門', '簡単', '普通', '難しい', '超難しい', '激ムズ'];
    const LEVEL_DIFFICULTIES = [30, 40, 50, 55, 60, 65];

    let gameState = {
      board: [],
      solution: [],
      initialBoard: [],
      selectedCell: null,
      level: 0,
      timer: 0,
      timerInterval: null,
      isPaused: false,
      isMemoMode: false,
      showErrors: false,
      memos: {}
    };

    function startGame(level) {
      gameState.level = level;
      gameState.board = [];
      gameState.solution = [];
      gameState.initialBoard = [];
      gameState.selectedCell = null;
      gameState.timer = 0;
      gameState.isPaused = false;
      gameState.isMemoMode = false;
      gameState.showErrors = false;
      gameState.memos = {};
      
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').classList.add('active');
      document.getElementById('level-name').textContent = LEVEL_NAMES[level];
      
      showCountdown();
    }

    function showCountdown() {
      const countdownScreen = document.getElementById('countdown-screen');
      const playScreen = document.getElementById('play-screen');
      
      countdownScreen.style.display = 'flex';
      playScreen.style.display = 'none';
      
      let count = 3;
      countdownScreen.innerHTML = `
        <div class="countdown-number">${count}</div>
        <div class="countdown-level">${LEVEL_NAMES[gameState.level]}</div>
      `;
      
      const countInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownScreen.innerHTML = `
            <div class="countdown-number">${count}</div>
            <div class="countdown-level">${LEVEL_NAMES[gameState.level]}</div>
          `;
        } else {
          clearInterval(countInterval);
          countdownScreen.style.display = 'none';
          playScreen.style.display = 'flex';
          initializeGame();
        }
      }, 1000);
    }

    function initializeGame() {
      generateSudoku();
      renderBoard();
      renderNumberPad();
      startTimer();
      updateButtonStates();
      
      window.addEventListener('resize', () => {
        renderNumberPad();
      });
    }

    function generateSudoku() {
      gameState.solution = generateCompleteSudoku();
      gameState.board = JSON.parse(JSON.stringify(gameState.solution));
      gameState.initialBoard = createPuzzle(gameState.board, LEVEL_DIFFICULTIES[gameState.level]);
      gameState.board = JSON.parse(JSON.stringify(gameState.initialBoard));
    }

    function generateCompleteSudoku() {
      const board = Array(9).fill(0).map(() => Array(9).fill(0));
      fillBoard(board);
      return board;
    }

    function fillBoard(board) {
      const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
      
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] === 0) {
            shuffleArray(numbers);
            for (const num of numbers) {
              if (isValidMove(board, row, col, num)) {
                board[row][col] = num;
                if (fillBoard(board)) {
                  return true;
                }
                board[row][col] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    }

    function isValidMove(board, row, col, num) {
      for (let x = 0; x < 9; x++) {
        if (board[row][x] === num || board[x][col] === num) {
          return false;
        }
      }
      
      const startRow = Math.floor(row / 3) * 3;
      const startCol = Math.floor(col / 3) * 3;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (board[startRow + i][startCol + j] === num) {
            return false;
          }
        }
      }
      return true;
    }

    function createPuzzle(solution, difficulty) {
      const puzzle = JSON.parse(JSON.stringify(solution));
      const cells = [];
      for (let i = 0; i < 9; i++) {
        for (let j = 0; j < 9; j++) {
          cells.push([i, j]);
        }
      }
      shuffleArray(cells);
      
      for (let i = 0; i < difficulty; i++) {
        const [row, col] = cells[i];
        puzzle[row][col] = 0;
      }
      return puzzle;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function renderBoard() {
      const boardElement = document.getElementById('board');
      boardElement.innerHTML = '';
      
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          const cellValue = gameState.board[row][col];
          
          if (gameState.initialBoard[row][col] !== 0) {
            cell.classList.add('initial');
            cell.textContent = cellValue;
          } else {
            cell.classList.add('editable');
            const memoKey = `${row}-${col}`;
            if (gameState.memos[memoKey] && gameState.memos[memoKey].length > 0) {
              const memoGrid = document.createElement('div');
              memoGrid.className = 'memo-grid';
              for (let i = 1; i <= 9; i++) {
                const memoCell = document.createElement('div');
                memoCell.className = 'memo-cell';
                memoCell.textContent = gameState.memos[memoKey].includes(i) ? i : '';
                memoGrid.appendChild(memoCell);
              }
              cell.appendChild(memoGrid);
            } else if (cellValue !== 0) {
              cell.textContent = cellValue;
            }
          }
          
          if (gameState.selectedCell && gameState.selectedCell[0] === row && gameState.selectedCell[1] === col) {
            cell.classList.add('selected');
            if (gameState.isMemoMode) {
              cell.classList.add('memo-active');
            }
          }
          
          if (gameState.showErrors && cellValue !== 0 && cellValue !== gameState.solution[row][col]) {
            cell.classList.add('wrong');
          }
          
          cell.addEventListener('click', () => selectCell(row, col));
          boardElement.appendChild(cell);
        }
      }
    }

    function renderNumberPad() {
      const padElement = document.getElementById('number-pad');
      padElement.innerHTML = '';
      
      const isLandscape = window.matchMedia('(orientation: landscape) and (max-height: 700px)').matches;
      
      if (isLandscape) {
        const errorBtn = document.createElement('button');
        errorBtn.className = 'control-btn error-btn landscape-btn';
        errorBtn.id = 'error-btn-landscape';
        errorBtn.innerHTML = '<i class="material-icons-round">error_outline</i>';
        errorBtn.addEventListener('click', toggleErrors);
        padElement.appendChild(errorBtn);
        
        const hintBtn = document.createElement('button');
        hintBtn.className = 'control-btn hint-btn landscape-btn';
        hintBtn.innerHTML = '<i class="material-icons-round">lightbulb</i>';
        hintBtn.addEventListener('click', getHint);
        padElement.appendChild(hintBtn);
        
        const resetBtn = document.createElement('button');
        resetBtn.className = 'control-btn reset-btn landscape-btn';
        resetBtn.innerHTML = '<i class="material-icons-round">refresh</i>';
        resetBtn.addEventListener('click', resetGame);
        padElement.appendChild(resetBtn);
        
        for (let i = 1; i <= 9; i++) {
          const btn = document.createElement('button');
          btn.className = 'number-btn landscape-btn';
          btn.textContent = i;
          btn.addEventListener('click', () => placeNumber(i));
          padElement.appendChild(btn);
        }
        
        const pauseBtn = document.createElement('button');
        pauseBtn.className = 'control-btn pause-btn landscape-btn';
        pauseBtn.id = 'pause-btn-landscape';
        pauseBtn.innerHTML = '<i class="material-icons-round">pause</i>';
        pauseBtn.addEventListener('click', togglePause);
        padElement.appendChild(pauseBtn);
        
        const memoBtn = document.createElement('button');
        memoBtn.className = 'control-btn memo-btn landscape-btn';
        memoBtn.id = 'memo-btn-landscape';
        memoBtn.innerHTML = '<i class="material-icons-round">edit_note</i>';
        memoBtn.addEventListener('click', toggleMemo);
        padElement.appendChild(memoBtn);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'number-btn delete-btn landscape-btn';
        deleteBtn.innerHTML = '<i class="material-icons-round">backspace</i>';
        deleteBtn.addEventListener('click', () => placeNumber(0));
        padElement.appendChild(deleteBtn);
        
        updateButtonStates();
      } else {
        for (let i = 1; i <= 9; i++) {
          const btn = document.createElement('button');
          btn.className = 'number-btn';
          btn.textContent = i;
          btn.addEventListener('click', () => placeNumber(i));
          padElement.appendChild(btn);
        }
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'number-btn delete-btn';
        deleteBtn.innerHTML = '<i class="material-icons-round">backspace</i>';
        deleteBtn.addEventListener('click', () => placeNumber(0));
        padElement.appendChild(deleteBtn);
      }
    }

    function selectCell(row, col) {
      if (gameState.isPaused) return;
      if (gameState.initialBoard[row][col] !== 0) return;
      gameState.selectedCell = [row, col];
      renderBoard();
    }

    function placeNumber(num) {
      if (!gameState.selectedCell || gameState.isPaused) return;
      const [row, col] = gameState.selectedCell;
      if (gameState.initialBoard[row][col] !== 0) return;
      
      const memoKey = `${row}-${col}`;
      
      if (gameState.isMemoMode && num !== 0) {
        if (!gameState.memos[memoKey]) {
          gameState.memos[memoKey] = [];
        }
        const index = gameState.memos[memoKey].indexOf(num);
        if (index > -1) {
          gameState.memos[memoKey].splice(index, 1);
        } else {
          gameState.memos[memoKey].push(num);
          gameState.memos[memoKey].sort();
        }
      } else {
        gameState.board[row][col] = num;
        if (num !== 0) {
          delete gameState.memos[memoKey];
        }
      }
      
      renderBoard();
      checkCompletion();
    }

    function checkCompletion() {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (gameState.board[row][col] !== gameState.solution[row][col]) {
            return;
          }
        }
      }
      gameComplete();
    }

    function gameComplete() {
      stopTimer();
      saveHistory();
      showClearScreen();
    }

    function showClearScreen() {
      document.getElementById('play-screen').style.display = 'none';
      const clearScreen = document.getElementById('clear-screen');
      clearScreen.classList.add('active');
      
      const minutes = Math.floor(gameState.timer / 60);
      const seconds = gameState.timer % 60;
      document.getElementById('clear-time').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('clear-level').textContent = 
        `難易度: ${LEVEL_NAMES[gameState.level]}`;
    }

    function startTimer() {
      gameState.timer = 0;
      gameState.timerInterval = setInterval(() => {
        if (!gameState.isPaused) {
          gameState.timer++;
          updateTimerDisplay();
        }
      }, 1000);
    }

    function stopTimer() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(gameState.timer / 60);
      const seconds = gameState.timer % 60;
      document.getElementById('timer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function toggleErrors() {
      gameState.showErrors = !gameState.showErrors;
      updateButtonStates();
      renderBoard();
    }

    function togglePause() {
      gameState.isPaused = !gameState.isPaused;
      const board = document.getElementById('board');
      
      if (gameState.isPaused) {
        board.classList.add('paused');
        
        // 各ボタンに個別にクラスを追加（一時停止ボタン以外）
        document.querySelectorAll('.control-btn:not(.pause-btn), .number-btn, .landscape-btn:not(.pause-btn)').forEach(btn => {
          btn.classList.add('paused-disabled');
        });
      } else {
        board.classList.remove('paused');
        
        // 非活性クラスを削除
        document.querySelectorAll('.paused-disabled').forEach(btn => {
          btn.classList.remove('paused-disabled');
        });
      }
      updateButtonStates();
    }

    function toggleMemo() {
      gameState.isMemoMode = !gameState.isMemoMode;
      const padElement = document.getElementById('number-pad');
      if (padElement) {
        if (gameState.isMemoMode) {
          padElement.classList.add('memo-mode');
        } else {
          padElement.classList.remove('memo-mode');
        }
      }
      updateButtonStates();
      renderBoard();
    }

    function updateButtonStates() {
      const errorBtn = document.getElementById('error-btn');
      const errorBtnLandscape = document.getElementById('error-btn-landscape');
      const pauseBtn = document.getElementById('pause-btn');
      const pauseBtnLandscape = document.getElementById('pause-btn-landscape');
      const memoBtn = document.getElementById('memo-btn');
      const memoBtnLandscape = document.getElementById('memo-btn-landscape');
      
      [errorBtn, errorBtnLandscape].forEach(btn => {
        if (btn) {
          if (gameState.showErrors) {
            btn.classList.add('active');
            const span = btn.querySelector('span');
            if (span) span.textContent = '表示中';
          } else {
            btn.classList.remove('active');
            const span = btn.querySelector('span');
            if (span) span.textContent = '間違い表示';
          }
        }
      });
      
      [pauseBtn, pauseBtnLandscape].forEach(btn => {
        if (btn) {
          if (gameState.isPaused) {
            btn.classList.add('active');
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            if (icon) icon.textContent = 'play_arrow';
            if (span) span.textContent = '再開';
          } else {
            btn.classList.remove('active');
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            if (icon) icon.textContent = 'pause';
            if (span) span.textContent = '一時停止';
          }
        }
      });
      
      [memoBtn, memoBtnLandscape].forEach(btn => {
        if (btn) {
          if (gameState.isMemoMode) {
            btn.classList.add('active');
            const span = btn.querySelector('span');
            if (span) span.textContent = 'メモ中';
          } else {
            btn.classList.remove('active');
            const span = btn.querySelector('span');
            if (span) span.textContent = 'メモ';
          }
        }
      });
    }

    function getHint() {
      if (gameState.isPaused || !gameState.selectedCell) return;
      const [row, col] = gameState.selectedCell;
      if (gameState.initialBoard[row][col] !== 0) return;
      
      gameState.board[row][col] = gameState.solution[row][col];
      const memoKey = `${row}-${col}`;
      delete gameState.memos[memoKey];
      renderBoard();
      checkCompletion();
    }

    function showConfirm(message, onConfirm) {
      const dialog = document.getElementById('confirm-dialog');
      const messageEl = document.getElementById('confirm-message');
      const okBtn = document.getElementById('confirm-ok-btn');
      
      messageEl.textContent = message;
      dialog.classList.add('active');
      
      okBtn.onclick = () => {
        hideConfirm();
        onConfirm();
      };
    }

    function hideConfirm() {
      const dialog = document.getElementById('confirm-dialog');
      dialog.classList.remove('active');
    }

    function resetGame() {
      if (gameState.isPaused) return;
      
      showConfirm('ゲームをリセットしますか?', () => {
        gameState.board = JSON.parse(JSON.stringify(gameState.initialBoard));
        gameState.selectedCell = null;
        gameState.memos = {};
        gameState.isPaused = false;
        gameState.isMemoMode = false;
        gameState.showErrors = false;
        
        stopTimer();
        gameState.timer = 0;
        startTimer();
        updateTimerDisplay();
        
        updateButtonStates();
        renderBoard();
      });
    }

    function backToMenu() {
      const clearScreen = document.getElementById('clear-screen');
      const gameScreen = document.getElementById('game-screen');
      const menuScreen = document.getElementById('menu-screen');
      
      if (clearScreen.classList.contains('active')) {
        stopTimer();
        gameScreen.classList.remove('active');
        clearScreen.classList.remove('active');
        menuScreen.style.display = 'flex';
        loadHistory();
        return;
      }
      
      showConfirm('メニューに戻ると現在のゲームは失われます。よろしいですか?', () => {
        stopTimer();
        gameScreen.classList.remove('active');
        clearScreen.classList.remove('active');
        menuScreen.style.display = 'flex';
        loadHistory();
      });
    }

    function replayLevel() {
      document.getElementById('clear-screen').classList.remove('active');
      startGame(gameState.level);
    }

    function saveHistory() {
      const history = JSON.parse(localStorage.getItem('sudokuHistory') || '[]');
      history.unshift({
        level: gameState.level,
        time: gameState.timer,
        date: new Date().toISOString()
      });
      localStorage.setItem('sudokuHistory', JSON.stringify(history.slice(0, 50)));
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('sudokuHistory') || '[]');
      const content = document.getElementById('history-content');
      const clearBtn = document.getElementById('clear-history-btn');
      
      if (history.length === 0) {
        content.innerHTML = '<div class="empty-history">まだクリア履歴がありません</div>';
        clearBtn.style.display = 'none';
      } else {
        clearBtn.style.display = 'flex';
        content.innerHTML = history.map((item, index) => {
          const date = new Date(item.date);
          const minutes = Math.floor(item.time / 60);
          const seconds = item.time % 60;
          return `
            <div class="history-item">
              <div class="history-info">
                <div class="history-level">${LEVEL_NAMES[item.level]}</div>
                <div class="history-date">${date.toLocaleDateString('ja-JP')}</div>
              </div>
              <div class="history-time">
                ${minutes}:${seconds.toString().padStart(2, '0')}
                <button class="delete-history-btn" onclick="deleteHistoryItem(${index})">
                  <i class="material-icons-round">delete</i>
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function deleteHistoryItem(index) {
      if (!confirm('この履歴を削除しますか?')) return;
      const history = JSON.parse(localStorage.getItem('sudokuHistory') || '[]');
      history.splice(index, 1);
      localStorage.setItem('sudokuHistory', JSON.stringify(history));
      loadHistory();
    }

    function clearHistory() {
      if (!confirm('全ての履歴を削除しますか?')) return;
      localStorage.removeItem('sudokuHistory');
      loadHistory();
    }

    function showTab(tabName, event) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      
      if (event && event.target) {
        event.target.closest('.tab').classList.add('active');
      }
      
      if (tabName === 'game') {
        document.getElementById('game-tab').classList.add('active');
      } else {
        document.getElementById('history-tab').classList.add('active');
        loadHistory();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadHistory();
      document.getElementById('clear-screen').classList.remove('active');
      document.getElementById('menu-screen').style.display = 'flex';
      document.getElementById('game-screen').classList.remove('active');
    });
  </script>
</body>
</html>
